"use strict";(self.webpackChunksimshop_frontend=self.webpackChunksimshop_frontend||[]).push([[920],{920(e,o,n){n.r(o),n.d(o,{default:()=>c});var t=n(43),i=n(722),d=n(104),a=n(579);const r={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:5000/api",s=r.replace("/api","");let l=null;const c=()=>{var e,o,n,c;const[p,x]=(0,t.useState)([]),[g,h]=(0,t.useState)([]),[u,f]=(0,t.useState)(!0),[m,b]=(0,t.useState)(null),[v,y]=(0,t.useState)(null),[j,S]=(0,t.useState)(""),[_,w]=(0,t.useState)("open"),[C,k]=(0,t.useState)(!1),A=(0,t.useRef)(null),z=()=>localStorage.getItem("token")||sessionStorage.getItem("token");(0,t.useEffect)(()=>{I()},[null===v||void 0===v?void 0:v.messages]);const I=()=>{var e;null===(e=A.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,t.useEffect)(()=>{const e=z();if(!e)return b("No hay sesi\xf3n activa"),void f(!1);D(e),R();const o=setInterval(R,5e3);return()=>{clearInterval(o)}},[]);const D=e=>{l||(console.log("\ud83d\udd0c [ADMIN] Conectando socket..."),l=(0,d.io)(s,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),l.on("connect",()=>{console.log("\u2705 [ADMIN] Socket conectado:",l.id),k(!0),l.emit("authenticate",e)}),l.on("disconnect",()=>{console.log("\u274c [ADMIN] Socket desconectado"),k(!1)}),l.on("authenticated",e=>{console.log("\u2705 [ADMIN] Autenticado:",e)}),l.on("new_user_message",e=>{console.log("\ud83d\udce8 [ADMIN] Nuevo mensaje de usuario:",e);const o=(null===e||void 0===e?void 0:e.chat)||e;null!==o&&void 0!==o&&o._id&&E(o)}),l.on("message_sent",e=>{console.log("\u2705 [ADMIN] Mensaje enviado:",e),null!==e&&void 0!==e&&e.success&&null!==e&&void 0!==e&&e.chat&&E(e.chat)}),l.on("chat_updated",e=>{console.log("\ud83d\udd04 [ADMIN] Chat actualizado:",e);const o=(null===e||void 0===e?void 0:e.chat)||e;null!==o&&void 0!==o&&o._id&&E(o)}),l.on("chat_closed",e=>{console.log("\ud83d\udd12 [ADMIN] Chat cerrado:",e);const o=(null===e||void 0===e?void 0:e.chat)||e;null!==o&&void 0!==o&&o._id&&N(o)}),l.on("message_error",e=>{console.error("\u274c [ADMIN] Error:",e),alert("Error: "+((null===e||void 0===e?void 0:e.message)||"Error desconocido"))}))},E=e=>{null!==e&&void 0!==e&&e._id&&(console.log("\ud83d\udd04 Actualizando chat ".concat(e._id,", status: ").concat(e.status)),"open"===e.status?(x(o=>o.find(o=>o._id===e._id)?o.map(o=>o._id===e._id?e:o):[e,...o]),h(o=>o.filter(o=>o._id!==e._id))):"closed"===e.status&&(h(o=>o.find(o=>o._id===e._id)?o.map(o=>o._id===e._id?e:o):[e,...o]),x(o=>o.filter(o=>o._id!==e._id))),y(o=>(null===o||void 0===o?void 0:o._id)===e._id?e:o))},N=e=>{null!==e&&void 0!==e&&e._id&&(console.log("\ud83d\udd12 Cerrando chat ".concat(e._id)),x(o=>o.filter(o=>o._id!==e._id)),h(o=>o.find(o=>o._id===e._id)?o.map(o=>o._id===e._id?e:o):[e,...o]),y(o=>(null===o||void 0===o?void 0:o._id)===e._id?(alert("\u2705 Chat finalizado correctamente"),null):o))},R=async()=>{try{const e=z();if(!e)return b("No hay sesi\xf3n activa"),void f(!1);console.log("\ud83d\udce5 [ADMIN] Cargando TODOS los chats...");const o=await i.A.get("".concat(r,"/chat/admin/chats"),{headers:{Authorization:"Bearer ".concat(e)}}),n=Array.isArray(o.data)?o.data:[],t=n.filter(e=>"open"===e.status),d=n.filter(e=>"closed"===e.status);console.log("\u2705 [ADMIN] Chats cargados:",{total:n.length,abiertos:t.length,cerrados:d.length}),x(t),h(d),b(null)}catch(o){var e;console.error("\u274c [ADMIN] Error al cargar chats:",o),b("Error al cargar chats"),401===(null===(e=o.response)||void 0===e?void 0:e.status)&&(alert("Sesi\xf3n expirada"),window.location.href="/login")}finally{f(!1)}},B="open"===_?p:g;return(0,a.jsxs)("div",{className:"admin-chat-container",style:{padding:"20px"},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px",background:"white",padding:"20px",borderRadius:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{style:{margin:"0 0 5px 0"},children:"\ud83d\udcac Panel de Soporte"}),(0,a.jsxs)("small",{style:{color:"#666"},children:["Abiertos: ",p.length," \u2022 Cerrados: ",g.length," \u2022 Total: ",p.length+g.length]})]}),(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 20px",background:C?"#d4edda":"#f8d7da",borderRadius:"25px",fontSize:"14px",fontWeight:"600"},children:[(0,a.jsx)("span",{style:{width:"12px",height:"12px",borderRadius:"50%",background:C?"#28a745":"#dc3545",display:"inline-block",animation:C?"pulse 2s infinite":"none"}}),C?"Conectado":"Desconectado"]})]}),(0,a.jsxs)("div",{style:{display:"flex",gap:"10px",marginBottom:"20px"},children:[(0,a.jsxs)("button",{onClick:()=>{w("open"),y(null)},style:{padding:"12px 24px",borderRadius:"25px",border:"none",background:"open"===_?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"#e9ecef",color:"open"===_?"white":"#495057",cursor:"pointer",fontWeight:"bold",fontSize:"15px",transition:"all 0.3s",boxShadow:"open"===_?"0 4px 12px rgba(102,126,234,0.4)":"none"},children:["\ud83d\udd25 Chats Activos ",(0,a.jsx)("span",{style:{marginLeft:"8px",padding:"2px 8px",background:"rgba(255,255,255,0.3)",borderRadius:"12px",fontSize:"13px"},children:p.length})]}),(0,a.jsxs)("button",{onClick:()=>{w("closed"),y(null)},style:{padding:"12px 24px",borderRadius:"25px",border:"none",background:"closed"===_?"#2c3e50":"#e9ecef",color:"closed"===_?"white":"#495057",cursor:"pointer",fontWeight:"bold",fontSize:"15px",transition:"all 0.3s",boxShadow:"closed"===_?"0 4px 12px rgba(44,62,80,0.4)":"none"},children:["\ud83d\udcc1 Historial ",(0,a.jsx)("span",{style:{marginLeft:"8px",padding:"2px 8px",background:"rgba(255,255,255,0.3)",borderRadius:"12px",fontSize:"13px"},children:g.length})]})]}),m&&(0,a.jsxs)("div",{style:{background:"#f8d7da",color:"#721c24",padding:"15px 20px",borderRadius:"8px",marginBottom:"20px",border:"1px solid #f5c6cb"},children:["\u26a0\ufe0f ",m]}),(0,a.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"350px 1fr",gap:"20px"},children:[(0,a.jsxs)("div",{style:{background:"white",borderRadius:"12px",border:"1px solid #dee2e6",height:"70vh",overflowY:"auto",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},children:[(0,a.jsx)("div",{style:{padding:"15px 20px",borderBottom:"1px solid #dee2e6",background:"#f8f9fa",position:"sticky",top:0,zIndex:10},children:(0,a.jsxs)("strong",{style:{fontSize:"15px",color:"#495057"},children:["open"===_?"\ud83d\udd25 En curso":"\ud83d\udcc1 Finalizados"," (",B.length,")"]})}),u?(0,a.jsxs)("div",{style:{padding:"40px 20px",textAlign:"center",color:"#adb5bd"},children:[(0,a.jsx)("div",{style:{fontSize:"40px",marginBottom:"10px"},children:"\u23f3"}),(0,a.jsx)("p",{children:"Cargando..."})]}):0===B.length?(0,a.jsxs)("div",{style:{padding:"60px 20px",textAlign:"center",color:"#adb5bd"},children:[(0,a.jsx)("div",{style:{fontSize:"48px",marginBottom:"15px"},children:"open"===_?"\ud83d\udcac":"\ud83d\udced"}),(0,a.jsx)("p",{style:{margin:0,fontSize:"15px",fontWeight:"500"},children:"open"===_?"No hay chats activos":"No hay historial"}),(0,a.jsx)("small",{style:{color:"#ced4da"},children:"open"===_?"Las conversaciones aparecer\xe1n aqu\xed":"Los chats finalizados aparecer\xe1n aqu\xed"})]}):B.map(e=>{var o,n;const t=null===(o=e.messages)||void 0===o?void 0:o[e.messages.length-1];return(0,a.jsxs)("div",{onClick:()=>y(e),style:{padding:"15px 20px",borderBottom:"1px solid #f1f3f5",cursor:"pointer",background:(null===v||void 0===v?void 0:v._id)===e._id?"#e7f3ff":"white",borderLeft:(null===v||void 0===v?void 0:v._id)===e._id?"4px solid #667eea":"4px solid transparent",transition:"all 0.2s"},children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"},children:[(0,a.jsx)("strong",{style:{color:"#212529"},children:(null===(n=e.user)||void 0===n?void 0:n.name)||"Cliente"}),"closed"===_&&(0,a.jsx)("span",{style:{padding:"2px 8px",background:"#d4edda",color:"#155724",fontSize:"10px",borderRadius:"10px",fontWeight:"600"},children:"\u2713 CERRADO"})]}),(0,a.jsx)("div",{style:{fontSize:"13px",color:"#6c757d",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",marginBottom:"4px"},children:(null===t||void 0===t?void 0:t.text)||"Sin mensajes"}),(null===t||void 0===t?void 0:t.timestamp)&&(0,a.jsx)("div",{style:{fontSize:"11px",color:"#adb5bd"},children:new Date(t.timestamp).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})})]},e._id)})]}),(0,a.jsx)("div",{style:{background:"white",borderRadius:"12px",border:"1px solid #dee2e6",display:"flex",flexDirection:"column",height:"70vh",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},children:v?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{style:{padding:"20px",borderBottom:"1px solid #dee2e6",display:"flex",justifyContent:"space-between",alignItems:"center",background:"#f8f9fa"},children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{style:{margin:"0 0 4px 0",color:"#212529"},children:[(null===(e=v.user)||void 0===e?void 0:e.name)||"Cliente","closed"===v.status&&(0,a.jsx)("span",{style:{marginLeft:"12px",fontSize:"14px",color:"#28a745",fontWeight:"normal"},children:"\u2713 Cerrado"})]}),(0,a.jsx)("small",{style:{color:"#6c757d"},children:(null===(o=v.user)||void 0===o?void 0:o.email)||""})]}),"open"===v.status&&(0,a.jsx)("button",{onClick:()=>(async e=>{if(window.confirm("\xbfFinalizar esta conversaci\xf3n?"))try{const o=z();console.log("\ud83d\udd12 [ADMIN] Cerrando chat:",e),await i.A.put("".concat(r,"/chat/admin/close-chat/").concat(e),{},{headers:{Authorization:"Bearer ".concat(o)}}),console.log("\u2705 [ADMIN] Chat cerrado correctamente"),await R()}catch(n){var o;console.error("\u274c [ADMIN] Error al cerrar chat:",n),alert("Error al cerrar chat"),401===(null===(o=n.response)||void 0===o?void 0:o.status)&&(window.location.href="/login")}})(v._id),style:{background:"#dc3545",color:"white",border:"none",padding:"10px 20px",borderRadius:"8px",cursor:"pointer",fontWeight:"600",fontSize:"14px",transition:"all 0.3s",boxShadow:"0 2px 8px rgba(220,53,69,0.3)"},children:"\u2713 Finalizar Chat"})]}),(0,a.jsxs)("div",{style:{flex:1,padding:"20px",overflowY:"auto",background:"#f8f9fa"},children:[0===(null===(n=v.messages)||void 0===n?void 0:n.length)?(0,a.jsxs)("div",{style:{textAlign:"center",color:"#adb5bd",marginTop:"50px"},children:[(0,a.jsx)("div",{style:{fontSize:"48px",marginBottom:"10px"},children:"\ud83d\udcac"}),(0,a.jsx)("p",{children:"No hay mensajes"})]}):null===(c=v.messages)||void 0===c?void 0:c.map((e,o)=>(0,a.jsx)("div",{style:{display:"flex",justifyContent:"admin"===e.sender?"flex-end":"flex-start",marginBottom:"12px"},children:(0,a.jsxs)("div",{style:{background:"admin"===e.sender?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"white",color:"admin"===e.sender?"white":"#212529",padding:"12px 16px",borderRadius:"12px",maxWidth:"70%",boxShadow:"0 2px 5px rgba(0,0,0,0.08)",border:"admin"===e.sender?"none":"1px solid #dee2e6"},children:[(0,a.jsx)("p",{style:{margin:"0 0 6px 0",wordWrap:"break-word",lineHeight:"1.4"},children:e.text}),(0,a.jsx)("small",{style:{fontSize:"10px",opacity:.7},children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},o)),(0,a.jsx)("div",{ref:A})]}),"open"===v.status?(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),j.trim()&&v&&C&&(console.log("\ud83d\udce4 [ADMIN] Enviando mensaje..."),l.emit("admin_send_message",{chatId:v._id,text:j}),S(""))},style:{padding:"20px",borderTop:"1px solid #dee2e6",display:"flex",gap:"12px",background:"white"},children:[(0,a.jsx)("input",{type:"text",value:j,onChange:e=>S(e.target.value),placeholder:"Escribe tu respuesta...",disabled:!C,style:{flex:1,padding:"12px 16px",borderRadius:"25px",border:"2px solid #dee2e6",outline:"none",fontSize:"14px",transition:"border-color 0.2s"},onFocus:e=>e.target.style.borderColor="#667eea",onBlur:e=>e.target.style.borderColor="#dee2e6"}),(0,a.jsx)("button",{type:"submit",disabled:!C||!j.trim(),style:{background:C&&j.trim()?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"#e9ecef",color:C&&j.trim()?"white":"#adb5bd",border:"none",padding:"12px 28px",borderRadius:"25px",cursor:C&&j.trim()?"pointer":"not-allowed",fontWeight:"bold",fontSize:"14px",transition:"all 0.3s",boxShadow:C&&j.trim()?"0 4px 12px rgba(102,126,234,0.3)":"none"},children:"Enviar \u2708\ufe0f"})]}):(0,a.jsx)("div",{style:{padding:"20px",borderTop:"1px solid #dee2e6",textAlign:"center",color:"#6c757d",background:"#f8f9fa",fontSize:"14px"},children:"\u2713 Esta conversaci\xf3n est\xe1 finalizada"})]}):(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"#adb5bd"},children:[(0,a.jsx)("div",{style:{fontSize:"64px",marginBottom:"20px"},children:"\ud83d\udcac"}),(0,a.jsx)("h3",{style:{margin:"0 0 8px 0",color:"#6c757d"},children:"Selecciona una conversaci\xf3n"}),(0,a.jsx)("p",{style:{margin:0,fontSize:"14px"},children:"Elige un chat de la lista para comenzar"})]})})]})]})}}}]);
//# sourceMappingURL=920.bdc55c00.chunk.js.map