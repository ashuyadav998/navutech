"use strict";(self.webpackChunksimshop_frontend=self.webpackChunksimshop_frontend||[]).push([[247],{247(e,s,a){a.r(s),a.d(s,{default:()=>c});var n=a(43),r=a(216),o=a(774),t=a(729),d=a(505),l=a(722),i=a(579);const c=()=>{const e=(0,r.Zp)(),{user:s,isAuthenticated:a}=(0,t.A)(),[c,h]=(0,n.useState)({totalProducts:0,totalOrders:0,totalUsers:0,totalRevenue:0,lowStock:0,pendingOrders:0,paidOrders:0}),[u,m]=(0,n.useState)([]),[g,x]=(0,n.useState)(!0),[j,p]=(0,n.useState)(null);(0,n.useEffect)(()=>{if(console.log("\ud83d\udd0d Verificando autenticaci\xf3n..."),console.log("isAuthenticated:",a()),console.log("user completo:",JSON.stringify(s,null,2)),console.log("user.role:",null===s||void 0===s?void 0:s.role),console.log("token en sessionStorage:",!!sessionStorage.getItem("token")),console.log("token en localStorage:",!!localStorage.getItem("token")),!a()){console.log("\u274c No autenticado, redirigiendo al login en 2 segundos...");const s=setTimeout(()=>e("/login"),2e3);return()=>clearTimeout(s)}if(s){if(console.log("\ud83d\udc64 Usuario cargado, verificando rol..."),"admin"!==s.role)return console.log("\u274c Usuario no es admin. Rol actual:",s.role),console.log('\u26a0\ufe0f Si eres admin, verifica que tu cuenta tenga role: "admin" en la base de datos'),p('Acceso denegado. Tu rol es: "'.concat(s.role,'". Necesitas rol "admin".')),void x(!1);console.log("\u2705 Usuario es admin, cargando datos..."),v()}else console.log("\u23f3 Esperando a que se cargue el usuario...")},[a,s,e]);const v=async()=>{try{var s,a,n;x(!0),p(null);const r={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:5000/api",o=sessionStorage.getItem("token")||localStorage.getItem("token");if(console.log("\ud83d\udd11 Token en sessionStorage:",!!sessionStorage.getItem("token")),console.log("\ud83d\udd11 Token en localStorage:",!!localStorage.getItem("token")),console.log("\ud83d\udd11 Token final encontrado:",o?"S\xcd":"NO"),console.log("\ud83d\udd11 Primeros caracteres:",o?o.substring(0,20)+"...":"N/A"),!o)return console.log("\u274c No hay token en sessionStorage ni localStorage"),p("No est\xe1s autenticado. Por favor, inicia sesi\xf3n."),x(!1),void e("/login");const t={headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"}};console.log("\ud83d\udd04 Cargando datos del dashboard...");const[i,c,u]=await Promise.all([(0,d.d$)({}).catch(e=>{var s;return console.error("\u274c Error cargando productos:",null===(s=e.response)||void 0===s?void 0:s.status,e.message),{data:[]}}),l.A.get("".concat(r,"/orders"),t).catch(e=>{var s,a;return console.error("\u274c Error cargando pedidos:",null===(s=e.response)||void 0===s?void 0:s.status,e.message),401===(null===(a=e.response)||void 0===a?void 0:a.status)&&console.log("\u26a0\ufe0f Token inv\xe1lido o expirado"),{data:[]}}),l.A.get("".concat(r,"/users"),t).catch(e=>{var s;return console.error("\u274c Error cargando usuarios:",null===(s=e.response)||void 0===s?void 0:s.status,e.message),{data:[]}})]),g=Array.isArray(i.data)?i.data:(null===(s=i.data)||void 0===s?void 0:s.products)||[],j=Array.isArray(c.data)?c.data:(null===(a=c.data)||void 0===a?void 0:a.orders)||[],v=Array.isArray(u.data)?u.data:(null===(n=u.data)||void 0===n?void 0:n.users)||[];console.log("\u2705 Datos cargados:",{productos:g.length,pedidos:j.length,usuarios:v.length});const N=j.filter(e=>"pagado"===e.paymentStatus).reduce((e,s)=>e+(s.totalAmount||0),0),b=g.filter(e=>(e.stock||0)<10).length,S=j.filter(e=>"pendiente"===e.orderStatus).length,f=j.filter(e=>"pagado"===e.paymentStatus).length;h({totalProducts:g.length,totalOrders:j.length,totalUsers:v.length,totalRevenue:N,lowStock:b,pendingOrders:S,paidOrders:f});const y=j.sort((e,s)=>new Date(s.createdAt)-new Date(e.createdAt));m(y.slice(0,5))}catch(j){var r,o,t,i;console.error("\u274c Error al cargar datos del dashboard:",j),console.error("\u274c Status:",null===(r=j.response)||void 0===r?void 0:r.status),console.error("\u274c Data:",null===(o=j.response)||void 0===o?void 0:o.data),401===(null===(t=j.response)||void 0===t?void 0:t.status)?(p("Tu sesi\xf3n ha expirado. Por favor, inicia sesi\xf3n nuevamente."),sessionStorage.removeItem("token"),localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>e("/login"),2e3)):403===(null===(i=j.response)||void 0===i?void 0:i.status)?(p("No tienes permisos para ver el dashboard de administrador."),setTimeout(()=>e("/"),2e3)):p("Error al cargar los datos. Por favor, intenta de nuevo.")}finally{x(!1)}},N=e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e||0),b=e=>({pendiente:"badge-warning",procesando:"badge-info",enviado:"badge-primary",entregado:"badge-success",cancelado:"badge-danger",pagado:"badge-success",fallido:"badge-danger"}[e]||"badge-secondary"),S=e=>({pendiente:"Pendiente",procesando:"Procesando",enviado:"Enviado",entregado:"Entregado",cancelado:"Cancelado",pagado:"Pagado",fallido:"Fallido"}[e]||e);return g?(0,i.jsx)("div",{className:"admin-dashboard",children:(0,i.jsxs)("div",{className:"loading-container",children:[(0,i.jsx)("div",{className:"spinner-large"}),(0,i.jsx)("p",{children:"Cargando dashboard..."})]})}):j?(0,i.jsx)("div",{className:"admin-dashboard",children:(0,i.jsxs)("div",{className:"error-container",children:[(0,i.jsx)("div",{className:"error-icon",children:"\u26a0\ufe0f"}),(0,i.jsx)("h3",{children:"Error al cargar el dashboard"}),(0,i.jsx)("p",{children:j}),j.includes("rol")&&s&&(0,i.jsxs)("div",{style:{marginTop:"20px",padding:"15px",background:"#f8f9fa",borderRadius:"8px",textAlign:"left"},children:[(0,i.jsx)("strong",{children:"\ud83d\udd0d Informaci\xf3n de Debug:"}),(0,i.jsx)("pre",{style:{marginTop:"10px",padding:"10px",background:"#fff",borderRadius:"4px",fontSize:"12px",overflow:"auto"},children:"Usuario: ".concat(s.name||"N/A","\nEmail: ").concat(s.email||"N/A","\nRol actual: ").concat(s.role||"sin rol","\nID: ").concat(s._id||s.id||"N/A")}),(0,i.jsxs)("p",{style:{marginTop:"10px",fontSize:"14px",color:"#666"},children:["\u2139\ufe0f Para acceder al dashboard de administrador, tu cuenta debe tener ",(0,i.jsx)("code",{children:'role: "admin"'})," en la base de datos."]})]}),(0,i.jsxs)("div",{className:"error-actions",children:[(0,i.jsxs)("button",{className:"btn btn-primary",onClick:v,children:[(0,i.jsx)(o.DIg,{})," Reintentar"]}),j.includes("sesi\xf3n")&&(0,i.jsx)("button",{className:"btn btn-secondary",onClick:()=>e("/login"),children:"Ir al Login"}),j.includes("rol")&&(0,i.jsx)("button",{className:"btn btn-secondary",onClick:()=>e("/"),children:"Volver a la tienda"})]})]})}):(0,i.jsxs)("div",{className:"admin-dashboard",children:[(0,i.jsxs)("div",{className:"dashboard-header",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{children:"\ud83d\udcca Resumen General"}),s&&(0,i.jsxs)("p",{className:"dashboard-subtitle",children:["Bienvenido, ",s.name]})]}),(0,i.jsxs)("button",{className:"btn btn-secondary btn-refresh",onClick:v,children:[(0,i.jsx)(o.DIg,{})," Actualizar"]})]}),(0,i.jsxs)("div",{className:"stats-grid",children:[(0,i.jsxs)("div",{className:"stat-card blue",children:[(0,i.jsx)("div",{className:"stat-icon",children:(0,i.jsx)(o.TXh,{})}),(0,i.jsxs)("div",{className:"stat-content",children:[(0,i.jsx)("h3",{children:"Productos"}),(0,i.jsx)("p",{className:"stat-number",children:c.totalProducts}),c.lowStock>0?(0,i.jsxs)("span",{className:"stat-alert",children:["\u26a0\ufe0f ",c.lowStock," con stock bajo"]}):(0,i.jsx)("span",{className:"stat-subtitle",children:"Stock saludable"})]})]}),(0,i.jsxs)("div",{className:"stat-card green",children:[(0,i.jsx)("div",{className:"stat-icon",children:(0,i.jsx)(o.IoZ,{})}),(0,i.jsxs)("div",{className:"stat-content",children:[(0,i.jsx)("h3",{children:"Pedidos"}),(0,i.jsx)("p",{className:"stat-number",children:c.totalOrders}),c.pendingOrders>0?(0,i.jsxs)("span",{className:"stat-alert",children:["\ud83d\udce6 ",c.pendingOrders," pendientes"]}):(0,i.jsx)("span",{className:"stat-subtitle",children:"Todo procesado"})]})]}),(0,i.jsxs)("div",{className:"stat-card purple",children:[(0,i.jsx)("div",{className:"stat-icon",children:(0,i.jsx)(o.YXz,{})}),(0,i.jsxs)("div",{className:"stat-content",children:[(0,i.jsx)("h3",{children:"Usuarios"}),(0,i.jsx)("p",{className:"stat-number",children:c.totalUsers}),(0,i.jsx)("span",{className:"stat-subtitle",children:"Registrados"})]})]}),(0,i.jsxs)("div",{className:"stat-card orange",children:[(0,i.jsx)("div",{className:"stat-icon",children:(0,i.jsx)(o.q83,{})}),(0,i.jsxs)("div",{className:"stat-content",children:[(0,i.jsx)("h3",{children:"Ingresos"}),(0,i.jsx)("p",{className:"stat-number",children:N(c.totalRevenue)}),(0,i.jsx)("span",{className:"stat-subtitle",children:"Total facturado"})]})]})]}),(c.pendingOrders>0||c.lowStock>0)&&(0,i.jsxs)("div",{className:"alerts-section",children:[(0,i.jsx)("h3",{children:"\u26a1 Alertas"}),(0,i.jsxs)("div",{className:"alerts-grid",children:[c.pendingOrders>0&&(0,i.jsxs)("div",{className:"alert-card warning",children:[(0,i.jsx)("span",{className:"alert-icon",children:"\ud83d\udce6"}),(0,i.jsxs)("div",{className:"alert-content",children:[(0,i.jsx)("strong",{children:"Pedidos Pendientes"}),(0,i.jsxs)("p",{children:["Tienes ",c.pendingOrders," pedido(s) pendiente(s) de procesar"]})]})]}),c.lowStock>0&&(0,i.jsxs)("div",{className:"alert-card danger",children:[(0,i.jsx)("span",{className:"alert-icon",children:"\u26a0\ufe0f"}),(0,i.jsxs)("div",{className:"alert-content",children:[(0,i.jsx)("strong",{children:"Stock Bajo"}),(0,i.jsxs)("p",{children:[c.lowStock," producto(s) con menos de 10 unidades"]})]})]})]})]}),(0,i.jsxs)("div",{className:"recent-orders",children:[(0,i.jsx)("h3",{children:"\ud83d\udccb Pedidos Recientes"}),u.length>0?(0,i.jsx)("div",{className:"table-responsive",children:(0,i.jsxs)("table",{className:"admin-table",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{children:"ID"}),(0,i.jsx)("th",{children:"Cliente"}),(0,i.jsx)("th",{children:"Tel\xe9fono"}),(0,i.jsx)("th",{children:"Fecha"}),(0,i.jsx)("th",{children:"Total"}),(0,i.jsx)("th",{children:"Estado Pago"}),(0,i.jsx)("th",{children:"Estado Pedido"})]})}),(0,i.jsx)("tbody",{children:u.map(e=>{var s,a,n;return(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{children:(0,i.jsxs)("strong",{children:["#",e._id.slice(-6)]})}),(0,i.jsx)("td",{children:(0,i.jsxs)("div",{className:"customer-info",children:[(0,i.jsx)("strong",{children:(null===(s=e.user)||void 0===s?void 0:s.name)||"Usuario"}),(0,i.jsx)("small",{children:(null===(a=e.user)||void 0===a?void 0:a.email)||""})]})}),(0,i.jsx)("td",{children:(0,i.jsx)("span",{className:"phone-text",children:e.phone||"N/A"})}),(0,i.jsx)("td",{children:(n=e.createdAt,n?new Date(n).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A")}),(0,i.jsx)("td",{children:(0,i.jsx)("strong",{children:N(e.totalAmount)})}),(0,i.jsx)("td",{children:(0,i.jsx)("span",{className:"badge ".concat(b(e.paymentStatus)),children:S(e.paymentStatus)})}),(0,i.jsx)("td",{children:(0,i.jsx)("span",{className:"badge ".concat(b(e.orderStatus)),children:S(e.orderStatus)})})]},e._id)})})]})}):(0,i.jsx)("div",{className:"no-data",children:(0,i.jsx)("p",{children:"\ud83d\udced No hay pedidos recientes"})})]}),(0,i.jsxs)("div",{className:"quick-summary",children:[(0,i.jsx)("h3",{children:"\ud83d\udcc8 Resumen R\xe1pido"}),(0,i.jsxs)("div",{className:"summary-grid",children:[(0,i.jsxs)("div",{className:"summary-item",children:[(0,i.jsx)("span",{className:"summary-label",children:"Pedidos Hoy:"}),(0,i.jsx)("span",{className:"summary-value",children:(()=>{const e=(new Date).toDateString();return u.filter(s=>new Date(s.createdAt).toDateString()===e).length})()})]}),(0,i.jsxs)("div",{className:"summary-item",children:[(0,i.jsx)("span",{className:"summary-label",children:"Tasa de Pago:"}),(0,i.jsxs)("span",{className:"summary-value",children:[0===c.totalOrders?0:Math.round(c.paidOrders/c.totalOrders*100),"%"]})]}),(0,i.jsxs)("div",{className:"summary-item",children:[(0,i.jsx)("span",{className:"summary-label",children:"Ticket Promedio:"}),(0,i.jsx)("span",{className:"summary-value",children:N(0===c.paidOrders?0:c.totalRevenue/c.paidOrders)})]})]})]})]})}}}]);
//# sourceMappingURL=247.16b9e305.chunk.js.map